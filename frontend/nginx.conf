# FILE: frontend/nginx.conf

# Configuração do servidor NGINX para o frontend
server {
    # O NGINX dentro do contêiner Docker ouvirá na porta 80
    listen 80;

    # O root é onde o 'frontend/Dockerfile' copiou nossos arquivos de build
    root /usr/share/nginx/html;

    # Tenta encontrar arquivos estáticos primeiro
    index index.html index.htm;

    # --- [INÍCIO DA CORREÇÃO] ---
    # O bloco "location = /index.html" foi REMOVIDO 
    # pois causava o loop de redirecionamento.
    # --- [FIM DA CORREÇÃO] ---

    # Redireciona /login.html (com .html) para /login (sem .html)
    location = /login.html {
        return 301 $scheme://$host/login;
    }

    # Redireciona /setup.html (com .html) para /setup (sem .html)
    location = /setup.html {
        return 301 $scheme://$host/setup;
    }

    # Faz a URL /login (sem .html) servir o arquivo /login.html
    location = /login {
        try_files /login.html =404;
    }

    # Faz a URL /setup (sem .html) servir o arquivo /setup.html
    location = /setup {
        try_files /setup.html =404;
    }

    # --- Roteamento de Arquivos Estáticos e SPA ---
    # Esta é a regra principal para servir seu aplicativo (ex: /calendar, /events)
    location / {
        # Tenta servir o arquivo exato solicitado (ex: /main.js)
        # Se não encontrar, tenta servir uma pasta (ex: /assets/)
        # Se falhar, redireciona para /index.html (para Single Page Applications)
        try_files $uri $uri/ /index.html;
    }

    # --- Roteamento do Proxy da API (A CORREÇÃO DO 404) ---
    # Qualquer requisição que comece com /api/ será tratada por este bloco.
    location /api/ {
        # 'backend' é o nome do seu serviço no 'docker-compose.yml'
        # '3000' é a porta que o 'backend' expõe DENTRO da rede docker
        
        # [MODERNO] Passa a requisição para o serviço backend
        proxy_pass http://backend:3000; 

        # [BOAS PRÁTICAS] Define os cabeçalhos corretos para o backend
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}